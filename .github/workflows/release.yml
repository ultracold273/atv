name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3
  workflow_dispatch:
    inputs:
      sign_release:
        description: 'Sign the release APK'
        required: false
        default: 'true'
        type: boolean

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true'

jobs:
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$TAG" >> $GITHUB_OUTPUT
          echo "Building release version: $TAG"

      # ===========================================
      # Signing Configuration
      # ===========================================
      - name: Decode keystore
        if: ${{ github.event.inputs.sign_release != 'false' }}
        id: decode_keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "No keystore configured, skipping signing"
            exit 0
          fi
          echo "$KEYSTORE_BASE64" | base64 -d > ${{ runner.temp }}/release-keystore.jks
          echo "KEYSTORE_PATH=${{ runner.temp }}/release-keystore.jks" >> $GITHUB_ENV
          echo "keystore_exists=true" >> $GITHUB_OUTPUT

      - name: Set signing environment variables
        if: steps.decode_keystore.outputs.keystore_exists == 'true'
        run: |
          echo "KEYSTORE_PASSWORD=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}" >> $GITHUB_ENV

      # ===========================================
      # Build Release APK
      # ===========================================
      - name: Build release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Verify APK was built
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: No APK found!"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "APK_NAME=$(basename $APK_PATH)" >> $GITHUB_ENV
          echo "Built APK: $APK_PATH"
          ls -la app/build/outputs/apk/release/

      - name: Check if APK is signed
        run: |
          if command -v apksigner &> /dev/null; then
            apksigner verify --print-certs "$APK_PATH" 2>&1 || echo "APK is unsigned (expected for builds without signing secrets)"
          else
            echo "apksigner not available, skipping signature check"
          fi

      # ===========================================
      # Upload Artifacts
      # ===========================================
      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-${{ steps.version.outputs.VERSION || 'manual' }}
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: error

      - name: Upload mapping file (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: mapping-${{ steps.version.outputs.VERSION || 'manual' }}
          path: app/build/outputs/mapping/release/mapping.txt
          retention-days: 90
          if-no-files-found: ignore

      # ===========================================
      # Cleanup
      # ===========================================
      - name: Cleanup keystore
        if: always() && steps.decode_keystore.outputs.keystore_exists == 'true'
        run: |
          rm -f ${{ runner.temp }}/release-keystore.jks
          echo "Keystore cleaned up"

  # ===========================================
  # Create GitHub Release (optional)
  # ===========================================
  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Download release APK
        uses: actions/download-artifact@v4
        with:
          name: release-apk-${{ github.ref_name }}
          path: ./release-apk

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: Release ${{ steps.version.outputs.TAG }}
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          files: ./release-apk/*.apk
          generate_release_notes: true
